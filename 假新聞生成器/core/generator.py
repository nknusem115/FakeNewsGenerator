

# -*- coding: utf-8 -*-

import logging
import random
import torch
from typing import Dict, List, Tuple
from transformers import GPT2LMHeadModel, GPT2TokenizerFast

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
print(f"使用設備: {device}")


tokenizer = GPT2TokenizerFast.from_pretrained("gpt2")
model = GPT2LMHeadModel.from_pretrained("gpt2")

model = model.to(device)
model.eval()



# 設定日誌
logging.basicConfig(
    level=logging.INFO,
    encoding='utf-8',
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('generator')

class KeywordManager:
    """管理關鍵詞（簡化版）"""
    def __init__(self):
        self.keywords = {
            "人物": [
                    "政府高官", "知名企業家", "國際明星", "資深記者", "著名科學家",
                    "運動健將", "網紅主播", "影視導演", "慈善家", "知名律師",
                  "音樂家", "藝術家", "環保人士", "社會活動家", "科技創業者"
                  "退休將軍", "反對派領導人", "神秘富豪", "資深外交官", "前總統",
                  "前首相", "知名作家", "社會名流", "網路紅人", "知名評論員"
                   "知名醫生", "知名學者", "知名企業家", "知名投資人", "知名設計師",
                   "知名運動員", "知名主持人", "知名網紅", "知名博主", "知名攝影師",
                   "知名科學家", "知名演員", "知名歌手", "知名作曲家", "知名編劇",
                   "知名導演", "知名藝術家", "知名舞者", "知名模特兒", "知名運動員",
                   "知名教練", "知名裁判", "知名評論員", "知名分析師", "知名專家",
                   "知名學者", "知名教授", "知名研究員", "知名科學家", "知名醫生",
                   "知名律師", "知名會計師", "知名顧問", "知名策展人", "知名編輯",
                   "知名記者", "知名攝影師", "知名設計師", "知名藝術家", "知名作家",
                   "知名詩人", "知名小說家", "知名散文家", "知名劇作家", "知名漫畫家",
                   "知名插畫家", "知名編劇", "知名導演", "知名製片人", "知名演員",
                   "知名歌手", "知名舞者", "知名模特兒", "知名運動員", "知名教練",
                   "知名裁判", "知名評論員", "知名分析師", "知名專家", "知名學者",
                   "知名教授", "知名研究員", "知名科學家", "知名醫生", "知名律師",
                   "知名會計師", "知名顧問", "知名策展人", "知名編輯", "知名記者",
                   "知名攝影師", "知名設計師", "知名藝術家", "知名作家", "知名詩人",
                    "知名小說家", "知名散文家", "知名劇作家", "知名漫畫家", "知名插畫家",
                    "知名編劇", "知名導演", "知名製片人", "知名演員", "知名歌手",
                    "知名舞者", "知名模特兒", "知名運動員", "知名教練", "知名裁判",
                    "知名評論員", "知名分析師", "知名專家", "知名學者", "知名教授",
                    "知名研究員", "知名科學家", "知名醫生", "知名律師", "知名會計師",
                    "知名顧問", "知名策展人", "知名編輯", "知名記者", "知名攝影師",
                    "知名設計師", "知名藝術家", "知名作家", "知名詩人", "知名小說家",
                    "知名散文家", "知名劇作家", "知名漫畫家", "知名插畫家", "知名編劇",
                    "知名導演", "知名製片人", "知名演員", "知名歌手", "知名舞者",
                    "知名模特兒", "知名運動員", "知名教練", "知名裁判", "知名評論員",
                    "知名分析師", "知名專家", "知名學者", "知名教授", "知名研究員",
                    "知名科學家", "知名醫生", "知名律師", "知名會計師", "知名顧問"],

            "事件": ["股市崩盤", "政府倒台", "明星出軌", "企業破產", "社會運動"
                    "環保抗議", "科技創新", "醫療醜聞", "金融詐騙", "國際衝突",
                    "網路攻擊", "恐怖襲擊", "自然災害", "政治醜聞", "經濟危機",
                    "社會運動", "環保抗議", "科技創新", "醫療醜聞", "金融詐騙",
                    "國際衝突", "網路攻擊", "恐怖襲擊", "自然災害", "政治醜聞",
                    "經濟危機", "社會運動", "環保抗議", "科技創新", "醫療醜聞",
                    "金融詐騙",
                    ],
            "國家": ["美國", "中國", "俄羅斯", "日本", "德國",
                    "法國", "英國", "印度", "巴西", "南非",
                    "韓國", "澳大利亞", "加拿大", "墨西哥", "阿根廷",
                    "意大利", "西班牙", "瑞士", "瑞典", "挪威",
                    "丹麥", "芬蘭", "荷蘭", "比利時", "奧地利",
                    ],
            "組織": ["聯合國", "世界衛生組織", "國際貨幣基金組織", "世界銀行", "北約",
                    "歐盟", "國際奧委會", "國際紅十字會", "世界貿易組織", "國際刑警",
                    "國際能源署", "國際原子能機構", "世界氣象組織", "國際電信聯盟", "世界知識產權組織",
                    "國際民航組織", "國際海事組織", "國際勞工組織", "國際農業發展基金",
                    "國際開發協會", "國際金融公司", "國際復興開發銀行", "國際投資銀行",
                    "國際開發銀行", "國際經濟合作與發展組織", "國際貿易中心", "國際貨幣基金組織",

                    ],

            
            "動作": ["簽署秘密協議", "洩露機密文件", "捐贈巨額資金", "突然辭職", "私下會晤"
                    "發表爭議言論", "參加秘密會議", "接受調查", "發布警告", "進行突襲",
                    "發起抗議", "提出訴訟", "發布聲明", "進行調查", "發起運動",
                    "進行談判", "發布報告", "進行檢查", "發起競選", "進行演講",
                    "發布公告", "進行調查", "發起運動", "進行談判", "發布報告"
                    
                    ],
            "政策": ["經濟刺激計劃", "環保法案", "稅收改革", "醫療改革", "教育政策",
                    "外交政策", "移民政策", "社會福利政策", "科技創新政策", "能源政策",
                    "農業政策", "貿易政策", "國防政策", "公共安全政策", "城市發展政策",
                    "文化政策", "體育政策", "交通運輸政策", "住房政策", "環境保護政策",
                    "勞動政策", "社會保障政策", "金融政策", "貨幣政策", "投資政策",
                    "科技政策", "創新政策", "數字經濟政策", "智慧城市政策", "綠色經濟政策",
                    "可持續發展政策", "氣候變化政策", "生態保護政策", "資源管理政策",
                    "生物多樣性政策", "水資源管理政策", "廢物管理政策", "空氣質量政策",
                    "土壤保護政策", "生態系統服務政策", "環境影響評估政策", "環境監測政策",
                    "環境教育政策", "環境法律政策", "環境管理政策", "環境技術政策",
                    "環境經濟政策", "環境社會政策", "環境文化政策", "環境倫理政策",
                    "環境科學政策", "環境技術政策", "環境管理政策", "環境經濟政策",
                    
                    ],
          
            "數字": ["10", "20", "30", "40", "50",
                    "60", "70", "80", "90", "100",
                    "200", "300", "400", "500", "600",
                    "700", "800", "900", "1000", "2000",
                    "3000", "4000", "5000", "6000", "7000",
                    "8000", "9000", "10000", "20000", "30000",
                    "40000", "50000", "60000", "70000", "80000",
                    "90000", "100000", "200000", "300000", "400000",
                    "500000", "600000", "700000", "800000", "900000",
                    "1000000", "2000000", "3000000", "4000000", "5000000",

                    ],
            "反應": ["強烈譴責", "公開支持", "保持沉默", "發表聲明", "緊急會議",
                    "發起抗議", "進行調查", "發布報告", "召開記者會", "發表評論",
                    "進行談判", "發布公告", "召開會議", "發起運動", "進行檢查",
                    "發布警告", "進行調查", "發起競選", "進行演講", "發布聲明",
                    "召開會議", "發起抗議", "進行調查", "發布報告", "召開記者會",
                    ],

            "物品": ["毒品", "武器", "違禁品", "危險化學品", "生物武器",
                    "核武器", "化學武器", "生化武器", "軍火", "毒品",
                    "違禁藥物", "危險品", "爆炸物", "生物材料", "化學材料",
                    "核材料", "放射性物質", "有毒物質", "危險廢物", "污染物",
                    "有害物質", "危險化學品", "危險生物材料", "危險核材料",
                    ],



            
            "結果": ["引發全國關注", "導致股市崩盤", "激起民眾抗議", "促使政府干預", "引起國際譴責"
                    "引發外交危機", "導致經濟損失", "引起媒體熱議", "促使政策改變", "引發社會動盪",
                    "導致人員傷亡", "引起國際關注", "導致國際制裁", "引發政治風波", "促使法律改革",
                    "導致社會不安", "引起專家警告", "導致環境污染", "引發健康危機", "促使科技進步",
                    "導致資源短缺", "引起經濟衰退", "導致社會分裂", "引發文化衝突", "促使國際合作",
                    ],


            "地點": ["北京", "華盛頓", "東京", "台北", "倫敦"
                    "巴黎", "柏林", "莫斯科", "首爾", "新德里",
                    "悉尼", "墨爾本", "多倫多", "巴西利亞", "布宜諾斯艾利斯",
                    "開羅", "內羅畢", "約翰內斯堡", "新加坡", "吉隆坡",
                    "曼谷", "雅加達", "河內", "胡志明市", "馬尼拉",
                    "馬尼拉", "雅典", "羅馬", "馬德里", "布拉格",
                    "布達佩斯", "維也納", "華沙", "布魯塞爾", "阿姆斯特丹",
                    "哥本哈根", "斯德哥爾摩", "赫爾辛基", "奧斯陸", "雷克雅維克",
                    "都柏林", "倫敦", "愛丁堡", "格拉斯哥", "曼徹斯特",
                    "利物浦", "伯明翰", "布里斯托", "卡迪夫", "南安普敦",
                    "諾丁漢", "謝菲爾德", "利茲", "哈德斯菲爾德", "巴斯",
                    "劍橋", "牛津", "坎特伯雷", "巴斯", "布萊頓",
                    "南安普敦", "朴茨茅斯", "哈羅蓋特", "約克", "利茲",
                    "曼徹斯特", "伯明翰", "利物浦", "格拉斯哥", "愛丁堡",
                    "阿伯丁", "邓迪", "斯特靈", "因弗內斯", "佩斯利",
                    "格拉斯哥", "愛丁堡", "阿伯丁", "邓迪", "斯特靈",
                    "因弗內斯", "佩斯利", "格拉斯哥", "愛丁堡", "阿伯丁",
                    "邓迪", "斯特靈", "因弗內斯", "佩斯利", "格拉斯哥",
                    "愛丁堡", "阿伯丁", "邓迪", "斯特靈", "因弗內斯",
                    "佩斯利", "格拉斯哥", "愛丁堡", "阿伯丁", "邓迪",
                    "斯特靈", "因弗內斯", "佩斯利", "格拉斯哥", "愛丁堡",
                    ],

            "文件": ["機密文件", "內部報告", "調查報告", "財務報表", "合約",
                    "備忘錄", "電子郵件", "會議紀錄", "新聞稿", "公告",
                    "聲明", "報告書", "研究報告", "計劃書", "預算案",
                    "政策文件", "法律文件", "合同", "協議書", "備忘錄",
                    "會議記錄", "新聞稿", "公告", "聲明", "報告書",
                    ],
                   

            "機構": ["中央銀行", "國安局", "世界衛生組織", "聯合國", "外交部"
                    "國防部", "環保署", "經濟部", "科技部", "教育部",
                    "交通部", "文化部", "勞動部", "農業部", "衛生福利部",
                    "內政部", "司法部", "財政部", "國土安全部", "商務部",
                    "能源部", "國務院", "國際貨幣基金組織", "世界銀行",
                    "世界貿易組織", "國際刑警組織", "國際原子能機構",
                    "國際電信聯盟", "國際民航組織", "國際海事組織", "國際勞工組織",
                    "國際農業發展基金", "國際開發協會", "國際金融公司",
                    "國際復興開發銀行", "國際投資銀行", "國際開發銀行",
                    "國際經濟合作與發展組織", "國際貿易中心", "國際貨幣基金組織",
                    "國際能源署", "國際原子能機構", "國際電信聯盟", "國際民航組織",
                    

                    ],
            "指控": ["貪污", "賄賂", "洗錢", "詐騙", "侵占公款",
                    "濫用職權", "貪污受賄", "偽造文件", "竊取機密", "侵害人權",
                    "違反國安法", "違反環保法", "違反勞動法", "違反稅法", "違反商業法",
                    "違反金融法", "違反刑法", "違反民法", "違反行政法", "違反國際法",
                    "違反人權法", "違反環境法", "違反消費者保護法", "違反智慧財產權法",
                    ],
            "症狀": ["頭痛", "發燒", "咳嗽", "噁心", "嘔吐",
                       "腹瀉", "肌肉疼痛", "關節疼痛", "喉嚨痛", "流感",
                        "過敏", "皮疹", "呼吸急促", "胸痛", "心悸",
                        "乏力", "失眠", "焦慮", "抑鬱", "注意力不集中",
                        "記憶力減退", "情緒波動", "食慾不振", "體重減輕", "體重增加",
                        ],
            "疾病": ["流感", "新冠肺炎", "糖尿病", "高血壓", "心臟病",
                       "癌症", "中風", "阿茲海默症", "帕金森病", "關節炎",
                        "哮喘", "過敏性鼻炎", "胃潰瘍", "肝炎", "腎衰竭",
                        "肺結核", "艾滋病", "梅毒", "乙型肝炎", "丙型肝炎",
                        "結核病", "麻疹", "腮腺炎", "水痘", "百日咳",
                        ],
            "爭議政策": ["稅收改革", "醫療改革", "環保法案", "移民政策", "教育政策",
                    "外交政策", "社會福利政策", "科技創新政策", "能源政策", "農業政策",
                    "貿易政策", "國防政策", "公共安全政策", "城市發展政策", "文化政策",
                    "體育政策", "交通運輸政策", "住房政策", "環境保護政策", "勞動政策",
                    "社會保障政策", "金融政策", "貨幣政策", "投資政策", "科技政策",
                    ],
            "動作": ["簽署協議", "發表演講", "進行調查", "發布報告", "召開會議",
                    "進行談判", "發布聲明", "發起抗議", "進行檢查", "發布公告",
                    "召開記者會", "發起運動", "進行演講", "發布警告", "進行調查",
                    "發起競選", "進行演講", "發布聲明", "召開會議", "發起抗議",
                    
                    ],
             "結果": ["引發全國關注", "導致股市崩盤", "激起民眾抗議", "促使政府干預", "引起國際譴責"
                    "引發外交危機", "導致經濟損失", "引起媒體熱議", "促使政策改變", "引發社會動盪",
                    "導致人員傷亡", "引起國際關注", "導致國際制裁", "引發政治風波", "促使法律改革",
                    "導致社會不安", "引起專家警告", "導致環境污染", "引發健康危機", "促使科技進步",
                    "導致資源短缺", "引起經濟衰退", "導致社會分裂", "引發文化衝突", "促使國際合作",

                    ],

             "關係":[   "合作", "對抗", "競爭", "友好", "敵對",
                    "中立", "互惠", "互利", "互相支持", "互相抵制",
                    "互相合作", "互相競爭", "互相對抗", "互相敵對", "互相中立",
                    "互相友好", "互相合作", "互相支持", "互相抵制", "互相競爭",
                    "互相對抗", "互相敵對", "互相中立", "互相友好", "互相合作",
                    "情侶", "夫妻", "朋友", "同事", "同學",
                    "鄰居", "親戚", "家人", "伴侶", "戀人",
                   "兄弟", "姐妹", "父母", "子女", "祖父母",
                    "孫子女", "叔叔", "阿姨", "舅舅", "姑姑",
                        "表兄弟", "表姐妹", "堂兄弟", "堂姐妹", "親家",
      
                    ],

              "公司": [
                  "台積電", "鴻海", "聯發科", "華碩", "宏碁",
                  "華為", "小米", "OPPO", "Vivo", "三星",
                  "索尼", "LG", "HTC", "聯想", "戴爾",
                  "惠普", "蘋果", "微軟", "谷歌", "亞馬遜",
                  "臉書", "推特", "Instagram", "Snapchat", "Pinterest",
                  "LinkedIn", "YouTube", "Netflix", "Spotify", "Uber",
                  "LV", "Gucci", "Chanel", "Prada", "Dior",
                  "Hermes", "Burberry", "Versace", "Armani", "Dolce & Gabbana",
                  "Fendi", "Valentino", "Bulgari", "Cartier",
                  "台塑", "中油", "中華電信", "台灣大哥大", "遠傳電信",
                  "亞太電信", "台灣之星", "特斯拉", "蔚來", "小鵬",
                  "理想", "比亞迪", "吉利", "長城", "廣汽", "奇瑞",
                  "迪士尼", "環球影業", "華納兄弟", "索尼影業", "派拉蒙影業",
                  "Hulu", "Amazon Prime Video", "Disney+", "Apple TV+",
                  "Paramount+", "Starz", "Showtime", "BritBox", "Acorn TV",
                  "Big hit", "Crunchyroll", "Funimation", "VRV", "HiDive",
                  "AnimeLab", "Animelab", "Bilibili", "Tencent Video", "iQIYI",
                  "Youku", "Mango TV", "Sohu Video", "LeTV", "PPTV",
                  "Baidu Video", "Sina Video", "163 Video", "QQ Video", "Weibo",
                  "富邦金控", "國泰金控", "台新金控", "永豐金控", "中信金控",
                  "元大金控", "第一金控", "華南金控", "兆豐金控", "台灣銀行",
                  "土地銀行", "合作金庫", "彰化銀行", "台中銀行", "高雄銀行",
                  "高盛", "摩根士丹利", "美林證券", "瑞士信貸", "德意志銀行",
                  "瑞士聯合銀行", "巴黎銀行", "荷蘭國際集團", "美聯儲", "美國銀行",
                  "摩根大通", "花旗銀行", "富國銀行", "美國運通", "萬事達卡",
                  "維薩卡", "Discover", "American Express", "Capital One",
                  "Chase", "Bank of America", "Wells Fargo", "Citibank",
                  "PNC Bank", "TD Bank", "US Bank", "SunTrust", "Regions Bank",
                  "BB&T", "KeyBank", "Silvergate Bank", "Ally Bank", "Marcus by Goldman Sachs",
                  "沃爾瑪", "家得寶", "Lowe's", "IKEA", "Ace Hardware",
                  "Costco", "Target", "Kroger", "Ahold Delhaize", "Aldi",
                  "Lidl", "Tesco", "Carrefour", "Metro", "7-Eleven",
                  "Circle K", "Shell", "BP", "ExxonMobil", "Chevron",
                  "Total", "ConocoPhillips", "Eni", "Repsol", "Petrobras",
                  "Sinopec", "Toyota", "Honda", "Nissan", "Mazda",
                  "Subaru", "Mitsubishi", "Suzuki", "Hyundai", "Kia",
                  "Volkswagen", "Audi", "Porsche", "Rolls Royce", "Bentley",
                  "McLaren", "Pagani", "Koenigsegg", "Trafigura", "Glencore",
                  "Vitol", "Mercuria", "Gunvor",
              ],
                 
             
                "技術": ["人工智慧", "區塊鏈", "雲計算", "大數據", "物聯網",
                        "虛擬實境", "擴增實境", "5G", "自駕車", "無人機",
                        "量子計算", "邊緣計算", "生物技術", "基因編輯", "納米技術",
                        "3D列印", "智能家居", "智能穿戴設備", "智能交通", "智能城市",
                        "智能製造", "智能農業", "智能醫療", "智能物流", "智能能源",
                        "智能環保", "智能安防", "智能金融", "智能教育", "智能娛樂",
                        "DNA測序", "基因組學", "蛋白質組學", "代謝組學", "單細胞測序",
                        "CRISPR技術", "基因編輯技術", "基因療法", "細胞療法", "免疫療法",
                        "幹細胞療法", "基因診斷", "基因檢測", "基因組學研究", "蛋白質組學研究",
                        "代謝組學研究", "單細胞測序研究", "基因編輯研究", "基因療法研究",
                        "細胞療法研究", "免疫療法研究", "幹細胞療法研究", "基因診斷研究",
                        "基因檢測研究", "基因組學技術", "蛋白質組學技術", "代謝組學技術",
                        ],
                
                
                
        }        


        
    
    def get_random_keyword(self, category: str) -> str:
        return random.choice(self.keywords.get(category, [f"某{category}"]))

class TemplateEngine:
    """模板引擎（簡化版）"""
    def __init__(self):
        self.templates = [
            {"template": "[人物]宣布[動作]，[結果]引發爭議", "category":"政治" },
{"template": "[人物]被爆與[國家]密會，[機構]緊急介入調查", "category": "政治"},
{"template": "[人物]宣布[政策]，專家警告將[結果]", "category": "政治"},
{"template": "[國家]情報顯示：[人物]涉嫌[動作]，恐引發[結果]", "category": "政治"},
{"template": "[人物]遭[機構]約談，疑與[事件]有關", "category": "政治"},
{"template": "[人物]公開批評[政策]，[機構]強硬回應", "category": "政治"},
{"template": "[人物]被揭露持有[資產]，[機構]要求解釋", "category": "政治"},
{"template": "[人物]突然[動作]，[國家]緊急召開會議", "category": "政治"},
{"template": "[人物]遭[國家]制裁，[機構]表態支持", "category": "政治"},
{"template": "[人物]密訪[地點]，疑進行[動作]", "category": "政治"},
{"template": "[人物]被爆收受[國家]資金，[機構]啟動調查", "category": "政治"},
{"template": "[人物]宣布退出[組織]，[國家]回應「[反應]」", "category": "政治"},
{"template": "[人物]遭[機構]指控[動作]，支持者抗議", "category": "政治"},
{"template": "[人物]公開[文件]，內容震驚[行業]", "category": "政治"},
{"template": "[人物]被爆與[人物]秘密合作，[機構]緊急澄清", "category": "政治"},
{"template": "[人物]遭[國家]通緝，[機構]證實已[動作]", "category": "政治"},
{"template": "[人物]宣布[政策]，[數字]%民眾反對", "category": "政治"},
{"template": "[人物]被爆操控[事件]，[機構]介入調查", "category": "政治"},
{"template": "[人物]遭[國家]驅逐，[機構]譴責「[反應]」", "category": "政治"},
{"template": "[人物]公開支持[爭議政策]，[機構]強烈反彈", "category": "政治"},
{"template": "[人物]宣布[動作]，[國家]威脅「[反應]」", "category": "政治"},
{"template": "[人物]遭[機構]凍結資產，疑涉[事件]", "category": "政治"},
{"template": "[人物]被爆與[國家]簽密約，[機構]否認", "category": "政治"},
{"template": "[人物]突然[動作]，[國家]緊急應變", "category": "政治"},
{"template": "[人物]遭[機構]起訴，罪名包括[指控]", "category": "政治"},
{"template": "[人物]公開[文件]，[國家]回應「[反應]」", "category": "政治"},
{"template": "[人物]被爆與[人物]密謀[事件]，[機構]介入", "category": "政治"},
{"template": "[人物]宣布[政策]，[國家]揚言報復", "category": "政治"},
{"template": "[人物]遭[機構]監控，疑涉[事件]", "category": "政治"},
{"template": "[人物]被爆與[國家]交換[資產]，[機構]調查中", "category": "政治"},
{"template": "[地點]驚傳[事件]，[人物]遭控[動作]", "category": "社會"},
{"template": "[地點]爆發[事件]，[數字]人[結果]", "category": "社會"},
{"template": "[地點]居民抗議[政策]，[機構]強制[動作]", "category": "社會"},
{"template": "[地點]發現[物品]，專家警告恐[結果]", "category": "社會"},
{"template": "[地點]驚現[現象]，[機構]緊急[動作]", "category": "社會"},
{"template": "[地點]發生[事件]，目擊者：「[描述]」", "category": "社會"},
{"template": "[地點]政府隱瞞[事件]，[人物]揭發真相", "category": "社會"},
{"template": "[地點]民眾集體[動作]，[機構]介入鎮壓", "category": "社會"},
{"template": "[地點]驚爆[事件]，[人物]遭逮捕", "category": "社會"},
{"template": "[地點]出現[現象]，科學家無法解釋", "category": "社會"},
{"template": "[地點]政府宣布[政策]，民眾怒批「[反應]」", "category": "社會"},
{"template": "[地點]驚傳[事件]，[機構]證實[結果]", "category": "社會"},
{"template": "[地點]居民集體[症狀]，疑與[物品]有關", "category": "社會"},
{"template": "[地點]爆發[事件]，[人物]呼籲[動作]", "category": "社會"},
{"template": "[地點]驚現[物品]，專家：恐導致[結果]", "category": "社會"},
{"template": "[地點]政府隱瞞[事件]，[人物]洩露文件", "category": "社會"},
{"template": "[地點]民眾抗議[政策]，[機構]強硬[動作]", "category": "社會"},
{"template": "[地點]驚爆[事件]，[機構]緊急[動作]", "category": "社會"},
{"template": "[地點]出現[現象]，[人物]警告「[反應]」", "category": "社會"},
{"template": "[地點]政府宣布[政策]，[數字]%民眾反對", "category": "社會"},
{"template": "[地點]驚傳[事件]，[機構]否認知情", "category": "社會"},
{"template": "[地點]居民集體[症狀]，[機構]調查中", "category": "社會"},
{"template": "[地點]爆發[事件]，[人物]要求[動作]", "category": "社會"},
{"template": "[地點]驚現[物品]，[機構]警告勿[動作]", "category": "社會"},
            
{"template": "[機構]最新報告：[動作]將導致[結果]", "category": "經濟"},
{"template": "[公司]宣布[動作]，[行業]股價[結果]", "category": "經濟"},
{"template": "[機構]警告：[政策]將導致[行業][結果]", "category": "經濟"},
{"template": "[公司]被爆[動作]，[數字]億資金蒸發", "category": "經濟"},
{"template": "[行業]巨頭[公司]突宣布[動作]，市場震盪", "category": "經濟"},
{"template": "[機構]報告：[行業]恐在[時間]內[結果]", "category": "經濟"},
{"template": "[公司]遭[機構]調查，疑涉[事件]", "category": "經濟"},
{"template": "[行業]驚傳[事件]，[公司]緊急[動作]", "category": "經濟"},
{"template": "[公司]被爆與[國家]密約，[機構]介入", "category": "經濟"},
{"template": "[行業]面臨[危機]，[公司]宣布[動作]", "category": "經濟"},
{"template": "[機構]預測：[政策]將使[行業][結果]", "category": "經濟"},
{"template": "[公司]突然[動作]，[數字]員工失業", "category": "經濟"},
{"template": "[行業]遭[事件]衝擊，[公司]股價[結果]", "category": "經濟"},
{"template": "[公司]被揭露[動作]，[機構]開罰[金額]", "category": "經濟"},
{"template": "[行業]巨頭[公司]涉[事件]，[機構]調查", "category": "經濟"},
{"template": "[公司]宣布[政策]，消費者怒批「[反應]」", "category": "經濟"},
{"template": "[行業]驚爆[事件]，[公司]緊急切割", "category": "經濟"},
{"template": "[機構]數據顯示：[行業]將[時間]內[結果]", "category": "經濟"},
{"template": "[公司]遭[國家]制裁，[行業]連帶受創", "category": "經濟"},
{"template": "[行業]面臨[危機]，[機構]呼籲[動作]", "category": "經濟"},
{"template": "[公司]被爆[動作]，[數字]%市場受影響", "category": "經濟"},
  
 
{"template": "[公司]發布[產品]，專家警告恐[結果]", "category": "科技"},
{"template": "[機構]研究：[技術]可能導致[現象]", "category": "科技"},
{"template": "[人物]宣布突破[技術]，[行業]震動", "category": "科技"},
{"template": "[公司]被爆[動作]，用戶個資外洩", "category": "科技"},
{"template": "[技術]實驗失控，[機構]緊急[動作]", "category": "科技"},
{"template": "[公司]遭駭客攻擊，[數字]筆資料遭竊", "category": "科技"},
{"template": "[人物]警告：[技術]恐引發[危機]", "category": "科技"},
{"template": "[公司]隱瞞[事件]，[人物]揭發真相", "category": "科技,"},
{"template": "[技術]遭濫用，[機構]呼籲立法管制", "category": "科技"},
{"template": "[公司]宣布[產品]，[數字]國禁用", "category": "科技"},
{"template": "[機構]發現：[技術]有[數字]%缺陷", "category": "科技"},
{"template": "[人物]爆料：[公司]秘密研發[技術]", "category": "科技"},
{"template": "[技術]實驗意外，[地點]緊急疏散", "category": "科技"},
{"template": "[公司]被控操控[數據]，[機構]調查", "category": "科技"} ,   
{"template": "[技術]突破，[人物]：將改變[行業]", "category": "科技"} ,
            
{"template": "獨家：[人物]被爆[動作]，[機構]緊急回應", "category": "娛樂"},
{"template": "[明星]被爆[動作]，粉絲怒批「[反應]」", "category": "娛樂"},
{"template": "[明星]與[明星]驚傳[關係]，經紀公司[反應]", "category": "娛樂"},
{"template": "[明星]遭控[動作]，[機構]介入調查", "category": "娛樂"},
{"template": "[明星]突然宣布[動作]，業界震驚", "category": "娛樂"},
{"template": "[明星]被爆與[人物]密會，[反應]", "category": "娛樂"},
{"template": "獨家：[人物]被爆[動作]，[機構]緊急回應", "category": "娛樂"},
{"template": "[明星]新作涉[爭議]，[數字]%觀眾抵制", "category": "娛樂"},
{"template": "[明星]遭[機構]封殺，疑因[事件]", "category": "娛樂"},
{"template": "[明星]公開[言論]，[人物]怒批「[反應]」", "category": "娛樂"},
{"template": "[明星]被揭露[動作]，[公司]切割", "category": "娛樂"},
{"template": "[明星]驚傳[事件]，[機構]證實[結果]", "category": "娛樂"},
{"template": "[明星]與[明星]被拍到[動作]，[機構]回應", "category": "娛樂"},
{"template": "[明星]被爆[動作]，[數字]%粉絲抵制", "category": "娛樂"},
{"template": "[明星]遭[機構]約談，疑涉[事件]", "category": "娛樂"},
{"template": "[明星]公開[言論]，[數字]%網友支持", "category": "娛樂"},
{"template": "[明星]被爆與[人物]密會，[機構]緊急澄清", "category": "娛樂"},
        ]



    def get_random_template(self) -> Tuple[str, str]:
        template = random.choice(self.templates)
        return template["template"], template["category"]
    
    def fill_template(self, template: str, keyword_manager: KeywordManager) -> Tuple[str, Dict]:
        used_keywords = {}
        while '[' in template:
            start = template.index('[')
            end = template.index(']')
            category = template[start+1:end]
            keyword = keyword_manager.get_random_keyword(category)
            used_keywords[category] = keyword
            template = template.replace(f"[{category}]", keyword, 1)
        return template, used_keywords

class FakeNewsGenerator:
    """假新聞生成器核心類"""
    def __init__(self):
        self.template_engine = TemplateEngine()
        self.keyword_manager = KeywordManager()
        logger.info("假新聞生成器初始化完成")

    def calculate_perplexity(self,sentence):
        inputs = tokenizer(sentence, return_tensors="pt")
        with torch.no_grad():
            outputs = model(**inputs, labels=inputs["input_ids"])
            loss = outputs.loss
        return torch.exp(loss).item()
    
    def generate_headline(self) -> Dict:
        """生成單個新聞標題"""
        template, category = self.template_engine.get_random_template()
        headline, used_keywords = self.template_engine.fill_template(template, self.keyword_manager)
        return {
            "headline": headline,
            "category": category,
            "keywords": used_keywords
        }
    
    def generate_batch(self, count: int = 5) -> List[Dict]:
        """批量生成標題"""
        results = []
        headlines_set = set()  # 使用集合來追蹤已生成的標題
    
        # 持續生成直到達到要求的數量
        while len(results) < count:
            news = self.generate_headline()
            headline = news["headline"]
        
            # 只有當標題不重複時才添加到結果中
            if headline not in headlines_set:
                ppl = self.calculate_perplexity(headline)  # 計算困惑度
                if ppl < 5:  # 你可以調整這個門檻
                    # 儲存、印出、加入列表等
                    headlines_set.add(headline)
                    results.append(news)
                else:
                    # 加入set，遇到同樣不自然的，直接略過
                    headlines_set.add(headline)
                    pass
                
                
    
        return results
       
    def save_to_file(self, results: List[Dict], filename: str = "generated_headlines.txt") -> None:
         """將生成的假新聞標題儲存到檔案中

         Args:
             results: 生成的假新聞標題列表
             filename: 儲存的檔案名，預設為 "generated_headlines.txt"
         """
         try:
             with open(filename, "w", encoding="utf-8") as file:
                 for i, headline in enumerate(results, 1):
                     output = f"{i}. {headline['headline']} ({headline['category']})"
                     file.write(output + "\n")
             logger.info(f"已成功將 {len(results)} 筆假新聞標題儲存到 {filename}")
             print(f"生成的標題已儲存到 {filename}")
         except Exception as e:
             logger.error(f"儲存檔案時發生錯誤: {e}")
             print(f"儲存檔案時發生錯誤: {e}")     


    
    
    
    
    
    


if __name__ == "__main__":
    generator = FakeNewsGenerator()
    print("=== 假新聞標題生成器 ===")
    
    while True:
        try:
            num = int(input("請輸入要生成的標題數量 (0退出): "))
            if num <= 0:
                break
            results = generator.generate_batch(num)
            # 顯示生成的標題
            for i, headline in enumerate(results, 1):
                output = f"{i}. {headline['headline']} ({headline['category']})"
                print(output)


            # 儲存結果到檔案
            generator.save_to_file(results)
                                
        except ValueError:
            print("請輸入有效數字！")